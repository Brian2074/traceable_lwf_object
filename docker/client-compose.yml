services:
  client:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: fedrep-yolo:latest
    container_name: fedrep_client_${CLIENT_ID:-0}
    command: >
      python src/start_client.py
        --server_address ${SERVER_ADDRESS:-127.0.0.1:8080}
        --client_id ${CLIENT_ID:-0}
        --exp_name ${EXP_NAME:-docker_run}
        --batch_size ${BATCH_SIZE:-16}
        --fedrep_body_epochs ${BODY_EPOCHS:-5}
        --fedrep_head_epochs ${HEAD_EPOCHS:-5}
        --kd_alpha ${KD_ALPHA:-0.5}
        --tasks_global ${TASKS:-1}
    volumes:
      - ../src:/app/src
      - ../datasets:/app/datasets
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    shm_size: '4gb'
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          memory: 6G
