services:
  server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: fedrep-yolo:latest
    container_name: fedrep_server
    command: >
      python src/start_server.py
        --num_clients ${NUM_CLIENTS:-2}
        --epochs_global ${ROUNDS:-40}
        --exp_name ${EXP_NAME:-fedrep_run}
    ports:
      - "8080:8080"
    volumes:
      - ../src:/app/src
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
        limits:
          memory: 6G

  client1:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: fedrep-yolo:latest
    container_name: fedrep_client_1
    command: >
      python src/start_client.py
        --server_address server:8080
        --client_id 0
        --exp_name ${EXP_NAME:-fedrep_run}
        --batch_size ${BATCH_SIZE:-8}
        --fedrep_body_epochs ${BODY_EPOCHS:-5}
        --fedrep_head_epochs ${HEAD_EPOCHS:-5}
        --kd_alpha ${KD_ALPHA:-0.5}
    depends_on:
      - server
    volumes:
      - ../src:/app/src
      - ../datasets:/app/datasets
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
        limits:
          memory: 6G

  client2:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: fedrep-yolo:latest
    container_name: fedrep_client_2
    command: >
      python src/start_client.py
        --server_address server:8080
        --client_id 1
        --exp_name ${EXP_NAME:-fedrep_run}
        --batch_size ${BATCH_SIZE:-8}
        --fedrep_body_epochs ${BODY_EPOCHS:-5}
        --fedrep_head_epochs ${HEAD_EPOCHS:-5}
        --kd_alpha ${KD_ALPHA:-0.5}
    depends_on:
      - server
    volumes:
      - ../src:/app/src
      - ../datasets:/app/datasets
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
        limits:
          memory: 6G
